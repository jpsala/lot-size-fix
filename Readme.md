# Issue: "Not Enough Money" Error in StrategyQuant-Generated EAs for MT5

## 1. The Problem

When using Expert Advisors (EAs) generated by StrategyQuant for index CFDs (e.g., NDX100) in MetaTrader 5, a "Not enough money" error frequently occurs, preventing trades from being opened. This issue can appear on one broker but not another, even with identical account sizes and risk settings.

The root cause is an incorrect lot size calculation within the generated MQL5 code. The EA calculates a lot size that is too large for the account's available margin because it misinterprets the instrument's properties on certain brokers.

## 2. The Root Cause: Inconsistent Broker Configurations

This issue stems from a fragile calculation in the StrategyQuant money management module that does not account for inconsistencies in how different brokers configure their CFD instruments.

The generated code calculates the instrument's point value (`PointValue`) using the following formula:

```mql5
double PointValue = SymbolInfoDouble(correctedSymbol, SYMBOL_TRADE_TICK_VALUE) / SymbolInfoDouble(correctedSymbol, SYMBOL_TRADE_TICK_SIZE);
```

This formula is unreliable. It assumes that a broker's `SYMBOL_TRADE_TICK_VALUE` will always be perfectly scaled with the instrument's `SYMBOL_TRADE_CONTRACT_SIZE`. This is not a safe assumption.

### Real-World Example: Darwinex vs. FundedNext

A comparison of the NDX100 instrument on two different brokers demonstrates the problem:

| Property | Darwinex | FundedNext |
| :--- | :--- | :--- |
| **`Contract size`** | **10** | **10** |
| `Tick size` | 0.1 | 0.01 |
| `Tick value` | 1.0 (inferred) | 0.01 |

- **On Darwinex**, the formula works by coincidence: `PointValue = 1.0 / 0.1 = 10`. This matches the `Contract size`, so the lot calculation is correct.
- **On FundedNext**, the formula fails: `PointValue = 0.01 / 0.01 = 1`. The script calculates a `PointValue` of $1, when the actual value based on the `Contract size` is $10.

As a result, on FundedNext, the EA underestimates the risk by a factor of 10 and calculates a lot size that is **10 times too large**, causing the "Not enough money" error.

## 3. The Solution

### The Code Fix

The fix is to modify the `PointValue` calculation to use the only reliable property for risk calculation: the symbol's contract size.

Change this line in the `.mq5` file:

**From:**
```mql5
double PointValue = SymbolInfoDouble(correctedSymbol, SYMBOL_TRADE_TICK_VALUE) / SymbolInfoDouble(correctedSymbol, SYMBOL_TRADE_TICK_SIZE);
```

**To:**
```mql5
double PointValue = SymbolInfoDouble(correctedSymbol, SYMBOL_TRADE_CONTRACT_SIZE);
```

This ensures the risk is calculated correctly on any broker, regardless of their server-side configuration.

### Automated Patch Tool

To simplify applying this fix, the `fix-SQ-scripts.exe` tool is provided. This tool automatically finds and replaces the incorrect line in any given `.mq5` file within the current directory and its subdirectories.

**How to use the tool:**

1.  Open a terminal.
2.  Run the program with a file pattern. For example, to patch all `.mq5` files in the current directory:

    ```shell
    .\fix-SQ-scripts.exe "*.mq5"
    or
    .\fix-SQ-scripts.exe "c:\scripts\Strategy*.mq5"
    ```

This will patch the files, making them ready for compilation in MetaEditor with the correct lot size calculation.

### The repo is here: https://github.com/jpsala/lot-size-fix